name: VPN Rotation and Data Update

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 8 * * *'  # Runs every day at 08:00 UTC
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GH_PAT }}      
    permissions:
      contents: read
      packages: write

    steps:
      - name: Setup - Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.repository }}/r-scraper:latest
          
          
  run-scraper:
    needs: build-and-push
    runs-on: ubuntu-latest
    name: run-${{ matrix.group.name }}  # ✅ Correctly reference the group name

    strategy:
      matrix:
        group:
          - { name: "Western-Europe", index: 0 }
          - { name: "Americas", index: 1 }
          - { name: "Asia-Pacific", index: 2 }
          - { name: "Eastern-Europe", index: 3 }
          - { name: "Middle-East", index: 4 }
          - { name: "Central-Asia", index: 5 }
          - { name: "Southern-Africa", index: 6 }
          - { name: "Western-Africa", index: 7 }
          - { name: "Caribbean", index: 8 }
          - { name: "Island-Nations", index: 9 }
          
    env:
      GITHUB_PAT: ${{ secrets.GH_PAT }}      
      TELEGRAM_BOT_ID: ${{ secrets.TELEGRAM_BOT_ID }}
      TELEGRAM_GROUP_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
      R_LIBS_USER: /github/home/r-libs
    permissions:
      contents: read
      
    steps:
      - name: Setup - Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Create directories
        run: |
          sudo mkdir -p /github/home/r-libs
          sudo chmod 777 /github/home/r-libs
          mkdir -p data historic targeting
          chmod -R 777 .

      # Set up Docker networking
      - name: Setup Docker Network
        run: docker network create vpn-network

      # Pull the pre-built R image
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Pre-built R Image
        run: docker pull ghcr.io/${{ github.repository }}/r-scraper:latest

      # Set up VPN container
      - name: Run NordVPN Container
        env:
          NORDVPN_TOKEN: ${{ secrets.NORDVPN_TOKEN }}
        run: |
          COUNTRIES=("United_States" "Canada" "Germany" "France" "Netherlands" "Australia" "Japan" "Sweden" "Spain")
          RANDOM_COUNTRY=${COUNTRIES[$RANDOM % ${#COUNTRIES[@]}]}
          echo "Selected VPN Country: $RANDOM_COUNTRY"
          
          docker run -d --name nordvpn \
            --cap-add=NET_ADMIN \
            --cap-add=NET_RAW \
            --network vpn-network \
            -e TOKEN=$NORDVPN_TOKEN \
            -e CONNECT=$RANDOM_COUNTRY \
            -e TECHNOLOGY=NordLynx \
            ghcr.io/bubuntux/nordvpn

      - name: Start R Container
        run: |
          docker run -d --name r-dev \
            --network container:nordvpn \
            -e GITHUB_PAT=${{ secrets.GH_PAT }} \
            -e TELEGRAM_BOT_ID=${{ secrets.TELEGRAM_BOT_ID }} \
            -e TELEGRAM_GROUP_ID=${{ secrets.TELEGRAM_GROUP_ID }} \
            -v ${PWD}/data:/workspace/data \
            -v ${PWD}/historic:/workspace/historic \
            -v ${PWD}/targeting:/workspace/targeting \
            -v /github/home/r-libs:/r-libs \
            ghcr.io/${{ github.repository }}/r-scraper:latest tail -f /dev/null

      - name: Wait for VPN to Establish
        run: |
          for i in {1..10}; do
            VPN_STATUS=$(docker exec nordvpn nordvpn status 2>&1 || echo "Error")
            echo "VPN Status Output: $VPN_STATUS"

            if echo "$VPN_STATUS" | grep -q "Connected"; then
              echo "✅ VPN Connected!"
              break
            fi

            echo "⏳ Waiting for VPN... Attempt $i/10"
            sleep 3
          done

          VPN_STATUS_FINAL=$(docker exec nordvpn nordvpn status 2>&1 || echo "Error")
          if ! echo "$VPN_STATUS_FINAL" | grep -q "Connected"; then
            echo "❌ VPN failed to connect after 10 attempts."
            exit 1
          fi

      - name: Infinite Loop Until Success
        env:
          MATRIX_INDEX: ${{ matrix.group.index }}
        run: |
          # ✅ Use indexed arrays 
          JOB_COUNTRIES=(
            "DE FR NL BE LU SE AT FI DK IE NO CH LI IS MT CY PT ES IT GR GB BY AX GI GG JE IM FO SJ GL"
            "US CA MX BR AR CL PE CO VE UY PY PA CR DO GT SV HN BO EC BZ GF PM PR RE"
            "AU NZ JP KR SG HK TW MY VN PH TH MM KH LA TL PG KI TO WS VU ID IN CN MO MN MP NC NU NF PW GU UM"
            "PL CZ SK HU BG RO SI HR EE LV LT MD MK BA RS AL ME XK UA RU"
            "EG SA AE QA KW JO IL LB OM IQ SY PS YE DZ MA TN LY BH IR SD"
            "KZ TM UZ TJ KG GE AM AZ TR AF PK NP BD LK MV"
            "ZA NG KE GH MA SN RW UG MW TZ ZM ZW NA LS BW SZ AO MG MZ BI KM SC MU"
            "BF BJ BI ML MR NE TG GM GN SL LR CV ST GQ GA CG CF TD CM CI CD SO ER DJ ET EH SS"
            "AG AI BB BS BM GD JM KN LC VC TT KY MS VG VI WF YT GP MF BL DM MQ SX"
            "AD MC SM VA FM MH NR TV FJ CK TK CX CC AQ HM BV TF GS SH PN SB TC BN BT FK GW GY HT NI SR"
          )

          # ✅ Correct way to access array element
          COUNTRY_JOBS="${JOB_COUNTRIES[$MATRIX_INDEX]}"
          
          echo "Processing countries: $COUNTRY_JOBS"

          for CNTRY in $COUNTRY_JOBS; do 
            echo "Processing country: $CNTRY"
            start_time=$(date +%s)  # Record the start time
  
            get_current_ip() { 
              docker exec r-dev curl -s ifconfig.me || echo "UNKNOWN"
            }
  
            PREV_IP=$(get_current_ip)
            echo "🌍 Initial IP: $PREV_IP"
  
            COUNTRIES=("Albania" "Algeria" "Andorra" "Angola" "Argentina" "Armenia"
                       "Australia" "Austria" "Azerbaijan" "Bahamas" "Bahrain" "Bangladesh" "Belgium"
                       "Belize" "Bermuda" "Bhutan" "Bolivia" "Bosnia_And_Herzegovina" "Brazil"
                       "Brunei_Darussalam" "Bulgaria" "Cambodia" "Canada" "Cayman_Islands" "Chile"
                       "Colombia" "Costa_Rica" "Croatia" "Cyprus" "Czech_Republic" "Denmark"
                       "Dominican_Republic" "Ecuador" "Egypt" "El_Salvador" "Estonia" "Finland"
                       "France" "Georgia" "Germany" "Ghana" "Greece" "Greenland" "Guam"
                       "Guatemala" "Honduras" "Hong_Kong" "Hungary" "Iceland" "India" "Indonesia"
                       "Ireland" "Isle_Of_Man" "Israel" "Italy" "Jamaica" "Japan" "Jersey"
                       "Jordan" "Kazakhstan" "Kenya" "Kuwait" "Lao_Peoples_Democratic_Republic"
                       "Latvia" "Lebanon" "Liechtenstein" "Lithuania" "Luxembourg" "Malaysia"
                       "Malta" "Mexico" "Moldova" "Monaco" "Mongolia" "Montenegro" "Morocco"
                       "Mozambique" "Myanmar" "Nepal" "Netherlands" "New_Zealand" "Nigeria"
                       "North_Macedonia" "Norway" "Pakistan" "Panama" "Papua_New_Guinea"
                       "Paraguay" "Peru" "Philippines" "Poland" "Portugal" "Puerto_Rico"
                       "Romania" "Senegal" "Serbia" "Singapore" "Slovakia" "Slovenia"
                       "South_Africa" "South_Korea" "Spain" "Sri_Lanka" "Sweden" "Switzerland"
                       "Taiwan" "Thailand" "Trinidad_And_Tobago" "Tunisia" "Turkey" "Ukraine"
                       "United_Arab_Emirates" "United_Kingdom" "United_States" "Uruguay"
                       "Uzbekistan" "Venezuela" "Vietnam")
                       
            while true; do
              current_time=$(date +%s)
              elapsed_time=$((current_time - start_time))
              elapsed_time_hr=$((elapsed_time / 3600))
              elapsed_time_min=$(((elapsed_time % 3600) / 60))
              elapsed_time_sec=$((elapsed_time % 60))
  
              echo "🕒 Time elapsed: ${elapsed_time_hr}h ${elapsed_time_min}m ${elapsed_time_sec}s"
  
              # Stop after 5 hours (GitHub Actions limit)
              if [ "$elapsed_time" -ge 18000 ]; then
                echo "🚫 5-hour time limit reached. Exiting."
                break
              fi
  
              # 🔄 **VPN Rotation Before Running get_audiences.R**
              echo "🔄 Rotating VPN before running get_audiences.R..."
  
              while true; do
                RANDOM_COUNTRY=${COUNTRIES[$RANDOM % ${#COUNTRIES[@]}]}
                echo "🌍 Connecting to: $RANDOM_COUNTRY"

                # Store previous IP before switching VPN
                PREV_IP=$(docker exec r-dev curl -s ifconfig.me || echo "UNKNOWN")
                echo "🔎 Previous IP: $PREV_IP"

                # Disconnect and force a reset
                docker exec nordvpn nordvpn disconnect || echo "No active connection."
                sleep 5

                # Connect to a new random country
                docker exec nordvpn nordvpn connect "$RANDOM_COUNTRY"
                sleep 10  

                # **Ensure VPN is fully connected before proceeding**
                for attempt in {1..10}; do
                  VPN_STATUS=$(docker exec nordvpn nordvpn status 2>&1 || echo "Error")
                  echo "VPN Status Output: $VPN_STATUS"

                  if echo "$VPN_STATUS" | grep -q "Connected"; then
                    # Check if IP has actually changed
                    NEW_IP=$(docker exec r-dev curl -s ifconfig.me || echo "UNKNOWN")
                    echo "🔎 New IP: $NEW_IP"

                    if [ "$NEW_IP" != "$PREV_IP" ] && [ "$NEW_IP" != "UNKNOWN" ]; then
                      echo "✅ VPN Rotation Successful! New IP: $NEW_IP"
                      break 2  # Exit both retry loop and main loop
                    else
                      echo "❌ VPN IP did not change. Retrying another country..."
                      break  # Try a different country
                    fi
                  fi

                  echo "❌ VPN Connection Failed. Retrying in 10 seconds... (Attempt $attempt/10)"
                  sleep 10

                  # If all 10 attempts fail, try a completely new country
                  if [ "$attempt" -eq 10 ]; then
                    echo "🚨 Failed to connect after 10 attempts. Trying a different country..."
                    break  # Exit inner loop to select a new VPN server
                  fi
                done
              done  # VPN rotation loop ends
  
              # 🚀 **Run get_audiences.R for this country**
              echo "🚀 Running get_audiences.R inside r-dev for $CNTRY..."
              docker exec r-dev Rscript /workspace/get_audiences.R $CNTRY
              EXIT_CODE=$?
  
              echo "🔄 Completed one iteration. Restarting VPN change + get_audiences.R..."
  
              # Keep looping
              echo "⏳ Waiting 30 seconds before the next iteration..."
              sleep 30
            done  # ✅ Outer WHILE loop ends
  
          done  # ✅ FOR loop ends
          
