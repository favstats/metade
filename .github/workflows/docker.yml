name: VPN Rotation and Data Update

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 8 * * *'  # Runs every day at 08:00 UTC
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GH_PAT }}      
    permissions:
      contents: read
      packages: write

    steps:
      - name: Setup - Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.repository }}/r-scraper:latest
          
          
jobs:
  run-scraper:
    needs: build-and-push
    runs-on: ubuntu-latest
    name: run-${{ matrix.group_name }}  # üëà Dynamic job naming

    strategy:
      matrix:
        group_name:
          - "Western-Europe"
          - "Americas"
          - "Asia-Pacific"
          - "Eastern-Europe"
          - "Middle-East"
          - "Central-Asia"
          - "Southern-Africa"
          - "Western-Africa"
          - "Caribbean"
          - "Island-Nations"
    env:
      GITHUB_PAT: ${{ secrets.GH_PAT }}      
      TELEGRAM_BOT_ID: ${{ secrets.TELEGRAM_BOT_ID }}
      TELEGRAM_GROUP_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
      R_LIBS_USER: /github/home/r-libs
    permissions:
      contents: read
      
    steps:
      - name: Setup - Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Create directories
        run: |
          sudo mkdir -p /github/home/r-libs
          sudo chmod 777 /github/home/r-libs
          mkdir -p data historic targeting
          chmod -R 777 .

      # Set up Docker networking
      - name: Setup Docker Network
        run: docker network create vpn-network

      # Pull the pre-built R image
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Pre-built R Image
        run: docker pull ghcr.io/${{ github.repository }}/r-scraper:latest

      # Set up VPN container
      - name: Run NordVPN Container
        env:
          NORDVPN_TOKEN: ${{ secrets.NORDVPN_TOKEN }}
        run: |
          COUNTRIES=("United_States" "Canada" "Germany" "France" "Netherlands" "Australia" "Japan" "Sweden" "Spain")
          RANDOM_COUNTRY=${COUNTRIES[$RANDOM % ${#COUNTRIES[@]}]}
          echo "Selected VPN Country: $RANDOM_COUNTRY"
          
          docker run -d --name nordvpn \
            --cap-add=NET_ADMIN \
            --cap-add=NET_RAW \
            --network vpn-network \
            -e TOKEN=$NORDVPN_TOKEN \
            -e CONNECT=$RANDOM_COUNTRY \
            -e TECHNOLOGY=NordLynx \
            ghcr.io/bubuntux/nordvpn

      - name: Start R Container
        run: |
          docker run -d --name r-dev \
            --network container:nordvpn \
            -e GITHUB_PAT=${{ secrets.GH_PAT }} \
            -e TELEGRAM_BOT_ID=${{ secrets.TELEGRAM_BOT_ID }} \
            -e TELEGRAM_GROUP_ID=${{ secrets.TELEGRAM_GROUP_ID }} \
            -v ${PWD}/data:/workspace/data \
            -v ${PWD}/historic:/workspace/historic \
            -v ${PWD}/targeting:/workspace/targeting \
            -v /github/home/r-libs:/r-libs \
            ghcr.io/${{ github.repository }}/r-scraper:latest tail -f /dev/null

      - name: Wait for VPN to Establish
        run: |
          for i in {1..10}; do
            VPN_STATUS=$(docker exec nordvpn nordvpn status 2>&1 || echo "Error")
            echo "VPN Status Output: $VPN_STATUS"

            if echo "$VPN_STATUS" | grep -q "Connected"; then
              echo "‚úÖ VPN Connected!"
              break
            fi

            echo "‚è≥ Waiting for VPN... Attempt $i/10"
            sleep 3
          done

          VPN_STATUS_FINAL=$(docker exec nordvpn nordvpn status 2>&1 || echo "Error")
          if ! echo "$VPN_STATUS_FINAL" | grep -q "Connected"; then
            echo "‚ùå VPN failed to connect after 10 attempts."
            exit 1
          fi

      - name: Infinite Loop Until Success
        run: |
          declare -A JOB_COUNTRIES
          
          # 1. Western & Central Europe (Includes Germany)
          JOB_COUNTRIES[1]="DE FR NL BE LU SE AT FI DK IE NO CH LI IS MT CY PT ES IT GR GB BY AX GI GG JE IM FO SJ GL"

          # 2. North & South America
          JOB_COUNTRIES[2]="US CA MX BR AR CL PE CO VE UY PY PA CR DO GT SV HN BO EC BZ GF PM PR RE"

          # 3. Asia-Pacific (East Asia & Oceania)
          JOB_COUNTRIES[3]="AU NZ JP KR SG HK TW MY VN PH TH MM KH LA TL PG KI TO WS VU ID IN CN MO MN MP NC NU NF PW GU UM"

          # 4. Eastern Europe & Baltic States
          JOB_COUNTRIES[4]="PL CZ SK HU BG RO SI HR EE LV LT MD MK BA RS AL ME XK UA RU"

          # 5. Middle East & North Africa
          JOB_COUNTRIES[5]="EG SA AE QA KW JO IL LB OM IQ SY PS YE DZ MA TN LY BH IR SD"

          # 6. Central Asia & Caucasus
          JOB_COUNTRIES[6]="KZ TM UZ TJ KG GE AM AZ TR AF PK NP BD LK MV"

          # 7. Sub-Saharan Africa (Southern & Eastern)
          JOB_COUNTRIES[7]="ZA NG KE GH MA SN RW UG MW TZ ZM ZW NA LS BW SZ AO MG MZ BI KM SC MU"

          # 8. Sub-Saharan Africa (Western & Central)
          JOB_COUNTRIES[8]="BF BJ BI ML MR NE TG GM GN SL LR CV ST GQ GA CG CF TD CM CI CD SO ER DJ ET EH SS"

          # 9. Caribbean & Small Island Nations
          JOB_COUNTRIES[9]="AG AI BB BS BM GD JM KN LC VC TT KY MS VG VI WF YT GP MF BL DM MQ SX"

          # 10. Smaller & Unclassified Nations
          JOB_COUNTRIES[10]="AD MC SM VA FM MH NR TV FJ CK TK CX CC AQ HM BV TF GS SH PN SB TC BN BT FK GW GY HT NI SR"
          
          COUNTRY_JOBS="${JOB_COUNTRIES[${{ matrix.job_index }}]}"
          
          echo "Processing countries: $COUNTRY_JOBS"

          for CNTRY in COUNTRY_JOBS; do
            echo "Processing country: $CNTRY"
            start_time=$(date +%s)  # Record the start time
  
            get_current_ip() { 
              docker exec r-dev curl -s ifconfig.me || echo "UNKNOWN"
            }
  
            PREV_IP=$(get_current_ip)
            echo "üåç Initial IP: $PREV_IP"
  
            COUNTRIES=("Albania" "Algeria" "Andorra" "Angola" "Argentina" "Armenia"
                       "Australia" "Austria" "Azerbaijan" "Bahamas" "Bahrain" "Bangladesh" "Belgium"
                       "Belize" "Bermuda" "Bhutan" "Bolivia" "Bosnia_And_Herzegovina" "Brazil"
                       "Brunei_Darussalam" "Bulgaria" "Cambodia" "Canada" "Cayman_Islands" "Chile"
                       "Colombia" "Costa_Rica" "Croatia" "Cyprus" "Czech_Republic" "Denmark"
                       "Dominican_Republic" "Ecuador" "Egypt" "El_Salvador" "Estonia" "Finland"
                       "France" "Georgia" "Germany" "Ghana" "Greece" "Greenland" "Guam"
                       "Guatemala" "Honduras" "Hong_Kong" "Hungary" "Iceland" "India" "Indonesia"
                       "Ireland" "Isle_Of_Man" "Israel" "Italy" "Jamaica" "Japan" "Jersey"
                       "Jordan" "Kazakhstan" "Kenya" "Kuwait" "Lao_Peoples_Democratic_Republic"
                       "Latvia" "Lebanon" "Liechtenstein" "Lithuania" "Luxembourg" "Malaysia"
                       "Malta" "Mexico" "Moldova" "Monaco" "Mongolia" "Montenegro" "Morocco"
                       "Mozambique" "Myanmar" "Nepal" "Netherlands" "New_Zealand" "Nigeria"
                       "North_Macedonia" "Norway" "Pakistan" "Panama" "Papua_New_Guinea"
                       "Paraguay" "Peru" "Philippines" "Poland" "Portugal" "Puerto_Rico"
                       "Romania" "Senegal" "Serbia" "Singapore" "Slovakia" "Slovenia"
                       "South_Africa" "South_Korea" "Spain" "Sri_Lanka" "Sweden" "Switzerland"
                       "Taiwan" "Thailand" "Trinidad_And_Tobago" "Tunisia" "Turkey" "Ukraine"
                       "United_Arab_Emirates" "United_Kingdom" "United_States" "Uruguay"
                       "Uzbekistan" "Venezuela" "Vietnam")
                       
            while true; do
              current_time=$(date +%s)
              elapsed_time=$((current_time - start_time))
              elapsed_time_hr=$((elapsed_time / 3600))
              elapsed_time_min=$(((elapsed_time % 3600) / 60))
              elapsed_time_sec=$((elapsed_time % 60))
  
              echo "üïí Time elapsed: ${elapsed_time_hr}h ${elapsed_time_min}m ${elapsed_time_sec}s"
  
              # Stop after 5 hours (GitHub Actions limit)
              if [ "$elapsed_time" -ge 18000 ]; then
                echo "üö´ 5-hour time limit reached. Exiting."
                break
              fi
  
              # üîÑ **VPN Rotation Before Running get_audiences.R**
              echo "üîÑ Rotating VPN before running get_audiences.R..."
  
              while true; do
                RANDOM_COUNTRY=${COUNTRIES[$RANDOM % ${#COUNTRIES[@]}]}
                echo "üåç Connecting to: $RANDOM_COUNTRY"
                
                # Disconnect and force a reset
                docker exec nordvpn nordvpn disconnect
                sleep 5
                
                # Connect to new random country
                docker exec nordvpn nordvpn connect "$RANDOM_COUNTRY"
                sleep 10  
  
                # Ensure VPN is fully connected before proceeding
                for i in {1..5}; do
                  VPN_STATUS=$(docker exec nordvpn nordvpn status 2>&1 || echo "Error")
                  echo "VPN Status Output: $VPN_STATUS"
  
                  if echo "$VPN_STATUS" | grep -q "Connected"; then
                    echo "‚úÖ VPN Connected!"
                    break
                  fi
  
                  echo "‚è≥ Waiting for VPN to establish... Attempt $i/5"
                  sleep 5
                done
  
                # Get the new IP
                NEW_IP=$(get_current_ip)
                echo "üîé New IP: $NEW_IP"
  
                if [ "$NEW_IP" != "$PREV_IP" ] && [ "$NEW_IP" != "UNKNOWN" ]; then
                  echo "‚úÖ VPN Rotation Successful! New IP: $NEW_IP"
                  PREV_IP=$NEW_IP
                  break  # Exit VPN rotation loop
                else
                  echo "‚ùå VPN IP did not change. Retrying another country..."
                  sleep 5
                fi
              done
  
              # üöÄ **Run get_audiences.R for this country**
              echo "üöÄ Running get_audiences.R inside r-dev for $CNTRY..."
              docker exec r-dev Rscript /workspace/get_audiences.R $CNTRY
              EXIT_CODE=$?
  
              echo "üîÑ Completed one iteration. Restarting VPN change + get_audiences.R..."
  
              # Keep looping
              echo "‚è≥ Waiting 30 seconds before the next iteration..."
              sleep 30
            done
        
